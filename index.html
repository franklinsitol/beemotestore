<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beemote Store - Produtos Fofos e Modernos</title>
    <style>
        /* [Manter todos os estilos CSS anteriores] */
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- [Manter toda a estrutura HTML anterior] -->

    <script>
        // Configurações da API - SOLUÇÃO CORRIGIDA
        const API_KEY = '0ff84c9e-f757-4868-be49-4209f2581c50';
        const PUBLISHER_ID = '1759561';
        
        // Usaremos um proxy CORS para contornar as restrições do navegador
        const CORS_PROXY = 'https://cors-anywhere.herokuapp.com/';
        const API_ENDPOINT = `https://api.awin.com/publishers/${PUBLISHER_ID}/products/`;

        // Elementos do DOM
        const featuredProductsGrid = document.getElementById('featured-products-grid');
        const allProductsGrid = document.getElementById('all-products-grid');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const categoryFilter = document.getElementById('category-filter');
        const sortBy = document.getElementById('sort-by');
        const pagination = document.getElementById('pagination');

        // Estado da aplicação
        let products = [];
        let filteredProducts = [];
        let currentPage = 1;
        const productsPerPage = 12;
        let categories = [];

        // Função para buscar produtos da API Awin - VERSÃO CORRIGIDA
        async function fetchProducts(searchTerm = '', category = '') {
            try {
                featuredProductsGrid.innerHTML = '<div class="loading"></div><p class="loading-text">Carregando produtos...</p>';
                allProductsGrid.innerHTML = '<div class="loading"></div><p class="loading-text">Carregando produtos...</p>';
                
                // Parâmetros da API
                const params = new URLSearchParams();
                params.append('format', 'json');
                params.append('relationship', 'joined');
                params.append('minPrice', '1'); // Filtra produtos com preço > 0
                
                if (searchTerm) {
                    params.append('search', searchTerm);
                }
                
                // Configuração da requisição com headers de autenticação
                const requestOptions = {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                };
                
                // Fazendo a requisição através do proxy CORS
                const response = await fetch(CORS_PROXY + API_ENDPOINT + '?' + params.toString(), requestOptions);
                
                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status} - ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data || !Array.isArray(data)) {
                    throw new Error('Formato de dados inesperado da API');
                }
                
                // Mapear os produtos da API para nosso formato
                products = data.map(product => ({
                    id: product.id,
                    title: product.product_name || 'Produto sem nome',
                    price: parseFloat(product.sale_price || product.price_amount || 0),
                    image: product.image_url || 'https://via.placeholder.com/300x300?text=Produto+Sem+Imagem',
                    category: product.category || 'Outros',
                    url: product.deep_link || product.link || '#',
                    merchant: product.merchant_name || 'Loja desconhecida'
                })).filter(product => product.price > 0); // Filtra produtos com preço válido
                
                filteredProducts = [...products];
                
                // Extrair categorias únicas
                categories = [...new Set(products.map(product => product.category))];
                populateCategoryFilter();
                
                displayFeaturedProducts();
                displayAllProducts();
                updatePagination();
                
            } catch (error) {
                console.error('Erro ao buscar produtos:', error);
                featuredProductsGrid.innerHTML = `
                    <p class="no-results">
                        Não foi possível carregar os produtos. 
                        <button onclick="fetchProducts()" style="
                            background: var(--primary-color);
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            margin-top: 10px;
                        ">
                            Tentar novamente
                        </button>
                    </p>
                `;
                allProductsGrid.innerHTML = '<p class="no-results">Não foi possível carregar os produtos.</p>';
            }
        }

        /* [Manter todas as outras funções JavaScript anteriores] */

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            // Primeiro precisamos ativar o proxy CORS (isso é temporário)
            fetch('https://cors-anywhere.herokuapp.com/corsdemo')
                .then(response => response.text())
                .then(() => fetchProducts()) // Só faz a requisição após ativar o proxy
                .catch(error => {
                    console.error('Erro ao ativar proxy CORS:', error);
                    // Tenta mesmo assim (pode não funcionar)
                    fetchProducts();
                });
            
            // [Manter o restante do código de inicialização]
        });
    </script>
</body>
</html>
